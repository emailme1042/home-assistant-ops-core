# Configuration Health Monitoring System
# Tracks include status, restart safety, and configuration health

- platform: command_line
  name: "Configuration Health Check"
  command: 'powershell.exe -Command "try { $config = Get-Content ''configuration.yaml'' -Raw; $includes = [regex]::Matches($config, ''!include[^\\s]*\\s+([^\\n]+)'').Count; $errors = 0; if ($config -match ''duplicate'') { $errors++ }; if ($config -match ''syntax error'') { $errors++ }; Write-Output \"includes:$includes,errors:$errors\" } catch { Write-Output \"includes:0,errors:1\" }"'
  scan_interval: 300
  value_template: >
    {% set data = value.split(',') %}
    {% set includes = data[0].split(':')[1] | int(0) %}
    {% set errors = data[1].split(':')[1] | int(0) %}
    {{ includes if errors == 0 else 0 }}
  json_attributes:
    - includes
    - errors
    - status
  json_attributes_template: >
    {
      "includes": {{ value.split(',')[0].split(':')[1] | int(0) }},
      "errors": {{ value.split(',')[1].split(':')[1] | int(0) }},
      "status": "{{ 'healthy' if value.split(',')[1].split(':')[1] | int(0) == 0 else 'unhealthy' }}"
    }

# Template sensors moved to includes/templates/configuration_health_monitoring.yaml
# Converted to modern template: sensor format to resolve HA repairs deprecation warnings