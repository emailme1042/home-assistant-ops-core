# System Stability Monitoring Sensors
# Purpose: Proactive monitoring to prevent crashes and detect instability patterns

template:
  - sensor:
      name: "System Stability Score"
      unique_id: system_stability_score
      state: >
        {% set uptime_hours = (states('sensor.uptime') | as_timestamp | int(0)) / 3600 %}
        {% set cpu_usage = states('sensor.processor_use') | float(0) %}
        {% set memory_free = states('sensor.memory_free') | float(0) %}
        {% set unavailable_count = states('sensor.unavailable_entities') | int(0) %}

        {# Base score starts at 100 #}
        {% set base_score = 100 %}

        {# Deduct for high CPU usage #}
        {% if cpu_usage > 80 %}
          {% set cpu_penalty = 30 %}
        {% elif cpu_usage > 60 %}
          {% set cpu_penalty = 15 %}
        {% elif cpu_usage > 40 %}
          {% set cpu_penalty = 5 %}
        {% else %}
          {% set cpu_penalty = 0 %}
        {% endif %}

        {# Deduct for low memory #}
        {% if memory_free < 100 %}
          {% set memory_penalty = 25 %}
        {% elif memory_free < 300 %}
          {% set memory_penalty = 10 %}
        {% else %}
          {% set memory_penalty = 0 %}
        {% endif %}

        {# Deduct for too many unavailable entities #}
        {% if unavailable_count > 1000 %}
          {% set unavailable_penalty = 20 %}
        {% elif unavailable_count > 500 %}
          {% set unavailable_penalty = 10 %}
        {% else %}
          {% set unavailable_penalty = 0 %}
        {% endif %}

        {# Bonus for good uptime (more than 1 hour) #}
        {% if uptime_hours > 24 %}
          {% set uptime_bonus = 5 %}
        {% elif uptime_hours > 1 %}
          {% set uptime_bonus = 2 %}
        {% else %}
          {% set uptime_bonus = 0 %}
        {% endif %}

        {% set final_score = base_score - cpu_penalty - memory_penalty - unavailable_penalty + uptime_bonus %}
        {{ [final_score, 0] | max | int }}
      unit_of_measurement: "%"
      icon_template: >
        {% set score = this.state | int(0) %}
        {% if score >= 90 %}
          mdi:shield-check
        {% elif score >= 70 %}
          mdi:shield-alert
        {% elif score >= 50 %}
          mdi:shield-half-full
        {% else %}
          mdi:shield-off
        {% endif %}

  - sensor:
      name: "Crash Risk Assessment"
      unique_id: crash_risk_level
      state: >
        {% set stability = states('sensor.system_stability_score') | int(0) %}
        {% set cpu = states('sensor.processor_use') | float(0) %}
        {% set memory = states('sensor.memory_free') | float(0) %}
        {% set uptime_hours = (states('sensor.uptime') | as_timestamp | int(0)) / 3600 %}

        {# High risk conditions #}
        {% if stability < 50 or cpu > 85 or memory < 50 or uptime_hours < 0.1 %}
          High
        {# Medium risk conditions #}
        {% elif stability < 75 or cpu > 60 or memory < 200 or uptime_hours < 1 %}
          Medium
        {# Low risk - system stable #}
        {% else %}
          Low
        {% endif %}
      icon_template: >
        {% set risk = this.state %}
        {% if risk == 'Low' %}
          mdi:check-circle
        {% elif risk == 'Medium' %}
          mdi:alert-circle
        {% elif risk == 'High' %}
          mdi:alert
        {% else %}
          mdi:help-circle
        {% endif %}

  - sensor:
      name: "Error Pattern Detection"
      unique_id: error_pattern_detector
      state: >
        {% set recent_errors = states('sensor.recent_log_errors') | int(0) %}
        {% set persistent_notifications = states('persistent_notification') | list | length %}

        {% if recent_errors > 50 or persistent_notifications > 10 %}
          Critical
        {% elif recent_errors > 20 or persistent_notifications > 5 %}
          Warning
        {% elif recent_errors > 5 %}
          Monitoring
        {% else %}
          Clean
        {% endif %}
      icon_template: mdi:alert-circle-check

  - sensor:
      name: "Resource Trend Monitor"
      unique_id: resource_trend_monitor
      state: >
        {% set cpu = states('sensor.processor_use') | float(0) %}
        {% set memory = states('sensor.memory_free') | float(0) %}

        {# Simple trend logic - could be enhanced with historical data #}
        {% if cpu > 70 and memory < 200 %}
          Degrading
        {% elif cpu > 50 or memory < 500 %}
          Stable-Watch
        {% else %}
          Optimal
        {% endif %}
      icon_template: mdi:trending-up

  - sensor:
      name: "Integration Health Score"
      unique_id: integration_health_score
      state: >
        {% set unavailable = states('sensor.unavailable_entities') | int(0) %}
        {% set total_entities = states.sensor | list | length + states.binary_sensor | list | length + states.switch | list | length %}

        {% if total_entities > 0 %}
          {% set availability_percent = ((total_entities - unavailable) / total_entities * 100) | round %}
          {{ [availability_percent, 0] | max }}
        {% else %}
          0
        {% endif %}
      unit_of_measurement: "%"
      icon_template: mdi:puzzle-check