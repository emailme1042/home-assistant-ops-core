---
# ESPHome Flow Sensor Bridge for SMT-100/200
# Connects RS485 flow sensors to Home Assistant via ESP32

esphome:
  name: flow-sensor-bridge
  friendly_name: "Flow Sensor Bridge"

esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "your-encryption-key-here"

ota:
  password: "your-ota-password-here"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Flow-Sensor-Bridge"
    password: "flowbridge123"

captive_portal:

# RS485 UART Configuration for SMT-100/200
uart:
  id: rs485_uart
  tx_pin: GPIO17  # Adjust pins based on your ESP32 board
  rx_pin: GPIO16
  baud_rate: 9600  # Check SMT-100/200 documentation
  parity: NONE
  stop_bits: 1

# Modbus configuration (if SMT-100/200 supports Modbus)
modbus:
  id: flow_modbus
  uart_id: rs485_uart

# Flow sensor configuration
sensor:
  - platform: modbus
    modbus_controller_id: flow_modbus
    name: "Hot Water Flow Rate"
    id: hot_water_flow
    address: 0x0001  # Adjust based on SMT-100/200 register map
    register_type: holding
    value_type: FP32  # Or U_WORD depending on sensor
    unit_of_measurement: "L/min"
    accuracy_decimals: 1
    state_class: measurement
    device_class: water

  - platform: modbus
    modbus_controller_id: flow_modbus
    name: "Total Hot Water Volume"
    id: hot_water_total
    address: 0x0003  # Adjust based on register map
    register_type: holding
    value_type: FP32
    unit_of_measurement: "L"
    accuracy_decimals: 1
    state_class: total_increasing
    device_class: water

# Binary sensor for flow detection
binary_sensor:
  - platform: template
    name: "Hot Water Flowing"
    id: hot_water_flowing
    device_class: moisture
    state_template: "{{ states('sensor.hot_water_flow') | float > 0.5 }}"

# Switch for valve control (if your flow sensor has a valve)
switch:
  - platform: modbus
    modbus_controller_id: flow_modbus
    name: "Hot Water Valve"
    address: 0x0005  # Adjust based on register map
    register_type: coil
    write_register_type: coil

# Status LED
light:
  - platform: status_led
    name: "Bridge Status"
    pin: GPIO2

# Restart button
button:
  - platform: restart
    name: "Restart Bridge"